---
title: "Fitting Marginal Cox Models with Clustered Interval-Censored Data"
author: ""
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Fitting Marginal Cox Models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(BCPP.Package)
```

## Overview

This vignette demonstrates how to use the functions in this package to estimate marginal Cox proportional hazards models for clustered interval-censored data, incorporating time-dependent covariates and stratification. The methodology is based on the composite likelihood framework developed in Cook et al. (2023).

This package also show how to generate simulated data that mimics the Bostwana Combination Prevention Project(BCPP) structure, using included data generation utilities.

## Simulating Data with Time-Dependent Covariates
We begin by simulating data from a clustered interval-censored survival model with time-varying covariates.

```{r}
set.seed(112358)

# Generate baseline hazard functions for each of 4 strata
baseline <- lapply(1:4, function(i) return_baseline(maxT = 320, knots = 8))

# Define stratification function
stratum_assign <- function(s) sample(1:4, s, replace = TRUE)

# Simulate the data
data <- gen_time_varying_cov(
  s = 200,
  group.size.range = c(20, 30),
  beta = c(-1, 0.5, 0),
  visits.generator = gen_visits,
  censoring.rate = 0,
  rho = 0.5,
  baseline = baseline,
  S = stratum_assign
)

head(data)
```

## Fitting the Model (without variance estimation)

```{r}
tdc_model_fit <- composite_coxIC(
  formula = Surv(left, right, type = "interval2") ~ treat + utt,
  data = data,
  strata = "stratum",
  clus = "group",
  id = "id",
  variance = FALSE
)

summary(tdc_model_fit)
```

## Visualizing the Baseline Functions
```{r}
plot(tdc_model_fit,
     type = c("cumulative hazard", "survival", "cumulative incidence"),
     combine = TRUE,
     x.title = "Time", legend.title = "Stratum")
```

## Fitting the Model (with variance estimation)
```{r}
tdc_model_fit_var <- composite_coxIC(
  formula = Surv(left, right, type = "interval2") ~ treat + utt,
  data = data,
  strata = "stratum",
  clus = "group",
  id = "id",
  variance = TRUE
)

summary(tdc_model_fit_var)

```
