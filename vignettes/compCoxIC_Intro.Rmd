---
title: 
author: "Katrina Wang"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Fitting Marginal Cox Models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
depends: [intCRT]
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(intCRT)
```

## Overview
This vignette demonstrates how to use the functions in intCRT to estimate marginal Cox proportional hazards models for clustered interval-censored data, with the option to incorporate time-dependent covariates, parametric time-varying covariate effects, and stratification of the baseline hazard functions. The methodology is based on the composite likelihood framework developed in [Cook et al.](https://pubmed.ncbi.nlm.nih.gov/36314377/) (2023)

This vignette also shows how to use the packageâ€™s data generation utilities in order to create simulated datasets that mimics the Botswana Combination Prevention Project (BCPP) structure, using included data generation utilities. +reference

## Clustered Interval-Censored Data
In survival analysis, interval censoring occurs when the exact time of an event (such as infection or failure) is not observed, but is known to lie within an interval between two observed times. This type of data usually arises in studies where observations are monitored at discrete time points (such as scheduled inspections). In biomedical and epidemiological studies, interval censored data are sometimes associated with clusters when the observations belongs to different groups. When interval censoring occurs alongside within-cluster dependence, the data are referred to as clustered interval-censored data.

## Population Model for the Marginal Cox Model
The model of the hazard function for the time-to-event given time-dependent covariate `X(t)` and stratification variable `Z` is:

$$
\lambda(t \mid X(t), Z) = \lambda_0(t; Z) \exp\left\{ \beta^T X(t) \right\}
$$
Where:
- $\lambda_0(t; Z)$ is a stratum-specific baseline hazard function.
- $\beta$ is a $p$-dimensional vector of covariate effect.
- $X(t)$ is a $p$-dimensional bounded covariate process informing the time-to-event distribution.
- $Z$ is a stratification variable indicating cluster or stratum.

## intCRT Data: Simulation & BCPP Dataset
intCRT package offers two main ways to work with data:

- Simulating data that incorporates time-dependent covariates.

- Exploring an analysis-ready dataset of HIV-negative individuals from the Botswana Combination Prevention Project (BCPP), formatted for survival analysis with clustered interval-censored data.

## Simulating Data with Time-Dependent Covariates
We begin by simulating data from a clustered interval-censored survival model with time-varying covariates. 

```{r}
set.seed(112358)

# Generate baseline hazard functions for each of 4 strata
baseline <- lapply(1:4, function(i) return_baseline(maxT = 320, knots = 8))

# Define stratification function
stratum_assign <- function(s) sample(1:4, s, replace = TRUE)
```

```{r}
# Simulate the data
data <- gen_time_dependent_cov(
  M = 200, 
  ni = c(20, 30),
  beta = c(-1, 0.5, 0),
  gen_visits = gen_visits_bcpp,
  cens = 0,
  rho = 0.5,
  baseline = baseline,
  S = stratum_assign)

head(data)
```

The `gen_time_dependent_cov()` function uses the following model that allows for time-dependent covariates:
$$
\lambda(t \mid X(t), Z) = \lambda_Z(t) \exp\left\{ \beta_1 X + \beta_2 P(t) + \beta_3 X P(t) \right\}
$$

THe model is used for simulating a clustered interval-censored dataset where:

- $Z$ is the value of stratification vector

- $X$ is the time-constant binary variable, representing treatment assignment

- $P(t)$ is the value of a time-dependent binary variable representing an indicator of whether or not the Botswana policy of Universal Test and Treat was in effect at study time $t$

For the example we used here, we have a total 200 clusters (`M = 200`), representing 200 distinct communities, and the cluster sizes are ranged from 20 to 30 individuals (`ni = c(20, 30)`). Note that in the example code, `beta = c(-1, 0.5, 0)`, $\beta$ has three value, representing the coefficients of $X, P(t)$ and $X*P(t)$.

- $\beta_1 = -1$ is the coefficient of the main effect (treatment assignment) indicator. -1 refers to  

- $\beta_2 = 0.5$ is the coefficient of the effect of the BCPP.

- $\beta_3 = 0$ refers to the interaction coefficient of the interaction of the treatment assignment and the BCPP schedule 0 refers to there is no effect for the interaction.


## Fitting the Model (without variance estimation)

The function used to fit the model is `composite_coxIC()`. This function obtains composite maximum likelihood estimators based on the marginal Cox regression model [see above]. 
#` need a citation
```{r}
tdc_model_fit <- composite_coxIC(
  formula = Surv(left, right, type = "interval2") ~ treat + utt,
  data = data,
  strata = "stratum",
  clus = "group",
  id = "id",
  variance = FALSE
)
```

In this example:

- `formula` specifies the marginal Cox model using Surv(left, right, type = "interval2") to indicate interval-censored data.

- `data` is the simulated dataset generated previously.

- `strata` specifies the stratification variable, aligning with stratum-specific baseline hazards.

- `clus` indicates the clustering variable, accounting for within-cluster dependence.

- `id` specifies the subject identifier, used for handling time-varying covariates.

- `variance` = FALSE disables variance estimation to reduce computation time.



```{r}
summary(tdc_model_fit)
```


```{r}
```


## Visualizing the Baseline Functions
```{r}
plot(tdc_model_fit,
     type = c("cumulative hazard", "survival", "cumulative incidence"),
     combine = TRUE,
     x.title = "Time", legend.title = "Stratum")
```

## Fitting the Model (with variance estimation)
```{r}
tdc_model_fit_var <- composite_coxIC(
  formula = Surv(left, right, type = "interval2") ~ treat + utt,
  data = data,
  strata = "stratum",
  clus = "group",
  id = "id",
  variance = TRUE
)

summary(tdc_model_fit_var)

```
