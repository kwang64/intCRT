---
title: "Fitting Marginal Cox Models for Clustered Interval-Censored Data"
author: "Katrina Wang"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Fitting Marginal Cox Models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

```


```{r setup}
library(intCRT)
```

## Overview
This vignette demonstrates how to use the intCRT package to fit marginal Cox proportional hazards models for clustered interval-censored survival data, with support for:

- time-dependent covariates

- parametric time-varying effects

- stratum-specific baseline hazards

- flexible simulation utilities for complex cluster structures

The methods implemented in intCRT follow the composite likelihood framework developed in [Cook et al.](https://pubmed.ncbi.nlm.nih.gov/36314377/) (2023), which provides valid inference for clustered interval-censored data when full likelihood methods are computationally infeasible.

This vignette also illustrates how to generate simulated datasets designed to mimic the structure of the Botswana Combination Prevention Project (BCPP).

## Clustered Interval-Censored Data
In survival analysis, interval censoring occurs when the event time is not observed exactly but is only known to lie between two observation times (e.g., between clinic visits or household surveys). This arises naturally in:
- biomedicals studies

- epidemiology surveillance

- community-based cluster randomized trails

When individuals are grouped into clusters, such as communities, households, or clinical sites, and share unobserved correlation, the data are referred to as clustered interval-censored data. 

## Population Model for the Marginal Cox Model
The model of the hazard function for the time-to-event given time-dependent covariate `X(t)` and stratification variable `Z` is:

$$
\lambda(t \mid X(t), Z) = \lambda_0(t; Z) \exp\left\{ \beta^T X(t) \right\}
$$
Where:
- $\lambda_0(t; Z)$ is a stratum-specific baseline hazard function.
- $\beta$ is a $p$-dimensional vector of covariate effect.
- $X(t)$ is a $p$-dimensional bounded covariate process informing the time-to-event distribution.
- $Z$ is a stratification variable indicating cluster or stratum.
The composite likelihood estimator targets the population-averaged (marginal) effect $\beta$ , while accounting for within-cluster dependence through robust variance estimation.

## intCRT Data: Simulation & BCPP Dataset
intCRT package offers two main ways to work with data:

1. Simulation tools for generating clustered interval-censored datasets with flexible cluster sizes, time-dependent covariates, and stratum-specific baseline hazards.

2. Exploring an analysis-ready dataset of HIV-negative individuals from the Botswana Combination Prevention Project (BCPP), formatted for survival analysis with clustered interval-censored data.

Below we demonstrate how to simulate an example dataset.

## Simulating Data with Time-Dependent Covariates
We begin by simulating data from a clustered interval-censored survival model with time-varying covariates. 

```{r}
set.seed(112358)

# Generate baseline hazard functions for each of 4 strata
baseline <- lapply(1:4, function(i) return_baseline(maxT = 320, knots = 8))

# Define stratification function
stratum_assign <- function(s) sample(1:4, s, replace = TRUE)
```

Next, we simulate a dataset that includes:
- a binary time-constant treatment variable X

- a time-dependent policy indicator P(t)

- their interaction

- clustered interval-censored outcomes

```{r}
# Simulate the data
data <- gen_time_dependent_cov(
  M = 10, 
  ni = c(20, 30),
  beta = c(-1, 0.5, 0),
  gen_visits = gen_visits_bcpp,
  cens = 0,
  rho = 0.5,
  baseline = baseline,
  S = stratum_assign)

head(data)
```

The `gen_time_dependent_cov()` function uses the following model that allows for time-dependent covariates:
$$
\lambda(t \mid X(t), Z) = \lambda_Z(t) \exp\left\{ \beta_1 X + \beta_2 P(t) + \beta_3 X P(t) \right\}
$$

The model is used for simulating a clustered interval-censored dataset where:

- $Z$ is the value of stratification vector

- $X$ is the time-constant binary variable, representing treatment assignment

- $P(t)$ is the value of a time-dependent binary variable representing an indicator of whether or not the Botswana policy of Universal Test and Treat (UTT) was in effect at study time $t$

For the example we used here, we have a total 10 clusters (`M = 10`), representing 200 distinct communities, and the cluster sizes are varied between 20 and 30 individuals (`ni = c(20, 30)`). 

Note that in the example code, `beta = c(-1, 0.5, 0)`, $\beta$ has three value, specifying the coefficients of $X, P(t)$ and $X*P(t)$.

- $\beta_1 = -1$ is the coefficient of the main effect (treatment assignment) indicator. -1 indicates that individuals in the treatment group have a lower event hazard, regardless of time period. 

- $\beta_2 = 0.5$ is the coefficient of the effect of the BCPP.

- $\beta_3 = 0$ refers to the interaction coefficient of the interaction of the treatment assignment and the BCPP schedule 0 refers to there is no effect for the interaction.

This simulated dataset will later be used to demonstrate model fitting using `composite_coxIC()`

## Fitting the Model (without variance estimation)

The function used to fit the model is `composite_coxIC()`. This function obtains composite maximum likelihood estimators based on the marginal Cox regression model [see above]. 

```{r}
tdc_model_fit <- composite_coxIC(
  formula = Surv(left, right, type = "interval2") ~ treat + utt,
  data = data[1:200, ],
  strata = "stratum",
  clus = "group",
  id = "id",
  variance = FALSE
)
```

In this example:

- `formula` specifies the marginal Cox model using Surv(left, right, type = "interval2") to indicate interval-censored data.

- `data` is the simulated dataset generated previously.

- `strata` specifies the stratification variable, aligning with stratum-specific baseline hazards.

- `clus` indicates the clustering variable, accounting for within-cluster dependence.

- `id` specifies the subject identifier, used for handling time-varying covariates.

- `variance` = FALSE disables variance estimation to reduce computation time.



```{r}
summary(tdc_model_fit)
```




## Visualizing the Baseline Functions
```{r}
plot(tdc_model_fit,
     type = c("cumulative hazard", "survival", "cumulative incidence"),
     combine = TRUE,
     x.title = "Time", legend.title = "Stratum")
```

## Fitting the Model (with variance estimation)
```{r}
tdc_model_fit_var <- composite_coxIC(
  formula = Surv(left, right, type = "interval2") ~ treat + utt,
  data = data,
  strata = "stratum",
  clus = "group",
  id = "id",
  variance = TRUE
)

summary(tdc_model_fit_var)

```
